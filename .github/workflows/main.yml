name: testing-pipe

on:
  push:
    branches: main

jobs:
  tag:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Get existing tags
        id: existing_tags
        run: |
          existing_tags=$(git tag --list "build-0.0.*")
          echo "::set-output name=tags::$existing_tags"

      - name: Determine next tag
        id: next_tag
        run: |
          existing_tags="${{ steps.existing_tags.outputs.tags }}"
          last_tag=""
          last_digit=0

          for tag in $existing_tags; do
            tag_digits=$(echo "$tag" | awk -F '.' '{print $3 + 1}')
            if [ "$tag_digits" -gt "$last_digit" ]; then
              last_tag=$tag
              last_digit=$tag_digits
            fi
          done

          next_digit=$((last_digit + 1))
          next_tag="build-0.0.$next_digit"
          echo "::set-output name=tag::$next_tag"

      - name: Create and push tag
        run: |
          git tag ${{ steps.next_tag.outputs.tag }}
          git push origin ${{ steps.next_tag.outputs.tag }}
